<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Report Card System</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f4f6f8;
    }
    h1 {
      text-align: center;
      color: #2c3e50;
    }
    .panel, .auth-panel, .user-panel {
      background-color: #ffffff;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease-in-out;
    }
    .form-group, .auth-form {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input, select {
      width: 90%;
      margin: 13px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      transition: border-color 0.3s;
    }
    input:focus, select:focus {
      border-color: #2980b9;
      outline: none;
    }
    button {
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      color: #fff;
      background-color: #3498db;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #2980b9;
    }
    .btn-success {
      background-color: #2ecc71;
    }
    .btn-success:hover {
      background-color: #27ae60;
    }
    .student-card {
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 15px;
    }
    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <h1>Student Report Card System</h1>

  <div class="auth-panel" id="auth-section">
    <h2>User Authentication</h2>
    <div class="auth-form">
      <input type="text" id="username" placeholder="Username">
      <input type="password" id="password" placeholder="Password">
      <!--select id="role">
        <option value="regular">Regular User</option>
        <option value="teacher">Teacher</option>
        <option value="admin">Admin</option>
      </select>
      <input type="text" id="secret-key" placeholder="Secret Key (required for teacher/admin)"-->
      <div style="margin-top: 10px">
        <button onclick="signIn()">Sign In</button>
        <button class="btn-success" onclick="signUp()">Sign Up</button>
      </div>
    </div>
  </div>

  <div class="panel" id="main-section" style="display:none">
    <h2>Add New Student</h2>
    <div class="form-group">
      <label>Student Name</label>
      <input type="text" id="student-name">
    </div>
    <div class="form-group">
      <label>Class</label>
      <input type="text" id="student-class">
    </div>
    <div class="form-group">
      <label>Subjects and Marks</label>
      <div id="subjects-container"></div>
      <button class="btn-success" onclick="addSubject()">Add Subject</button>
    </div>
    <button class="btn-success" onclick="saveStudent()">Save Student</button>
  </div>

  <div class="controls" id="controls-section" style="display:none">
    <button onclick="calculateAll()">Calculate Averages</button>
    <button onclick="rankStudents()">Rank Students</button>
    <button onclick="generateAllPDF()">Generate All PDF</button>
  </div>

  <div class="user-panel" id="user-section" style="display:none">
    <h2>View Student Reports</h2>
    <div id="students-list-user"></div>
  </div>

  <div id="students-list"></div>

  <script>
    const { jsPDF } = window.jspdf;
    let students = [];
    let users = JSON.parse(localStorage.getItem('users')) || {};
    let currentUser = null;

    function toast(message, color = '#3498db') {
      Toastify({ text: message, backgroundColor: color, duration: 3000 }).showToast();
    }

    function signIn() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      if (users[username] && users[username].password === password) {
        currentUser = username;
        students = users[username].students || [];
        document.getElementById('auth-section').style.display = 'none';
        if (users[username].role === 'regular') {
          document.getElementById('user-section').style.display = 'block';
          renderStudents(true);
        } else {
          document.getElementById('main-section').style.display = 'block';
          document.getElementById('controls-section').style.display = 'flex';
          renderStudents();
        }
        toast('Signed in successfully!', '#2ecc71');
      } else {
        toast('Invalid credentials', '#e74c3c');
      }
    }

    function signUp() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      const role = document.getElementById('role').value;
      const secret = document.getElementById('secret-key').value.trim();
      if (users[username]) {
        toast('Username already exists', '#e74c3c');
        return;
      }
      if ((role === 'teacher' || role === 'admin') && secret !== 'bewise@') {
        toast('Invalid secret key for ' + role, '#e74c3c');
        return;
      }
      users[username] = { password, role, students: [] };
      localStorage.setItem('users', JSON.stringify(users));
      toast('Account created & signed in!', '#2ecc71');
      currentUser = username;
      students = [];
      document.getElementById('auth-section').style.display = 'none';
      if (role === 'regular') {
        document.getElementById('user-section').style.display = 'block';
        renderStudents(true);
      } else {
        document.getElementById('main-section').style.display = 'block';
        document.getElementById('controls-section').style.display = 'flex';
        renderStudents();
      }
    }

    function addSubject() {
      const div = document.createElement('div');
      div.innerHTML = `<input placeholder="Subject" class="subject-name"/> <input type="number" placeholder="Mark" class="subject-mark"/>`;
      document.getElementById('subjects-container').appendChild(div);
    }

    function saveStudent() {
      const name = document.getElementById('student-name').value.trim();
      const className = document.getElementById('student-class').value.trim();
      const subjectEls = document.querySelectorAll('#subjects-container div');
      const subjects = [];
      subjectEls.forEach(row => {
        const name = row.querySelector('.subject-name').value.trim();
        const mark = parseFloat(row.querySelector('.subject-mark').value);
        if (name && !isNaN(mark)) subjects.push({ name, mark });
      });
      if (!name || !className || subjects.length === 0) {
        toast('Please complete all fields.', '#e67e22');
        return;
      }
      students.push({ name, class: className, subjects });
      users[currentUser].students = students;
      localStorage.setItem('users', JSON.stringify(users));
      document.getElementById('student-name').value = '';
      document.getElementById('student-class').value = '';
      document.getElementById('subjects-container').innerHTML = '';
      renderStudents();
      toast('Student saved!', '#2ecc71');
    }

    function calculateAll() {
      students.forEach(s => {
        const total = s.subjects.reduce((sum, sub) => sum + sub.mark, 0);
        s.average = (total / s.subjects.length).toFixed(2);
        s.status = s.average >= 10 ? 'Passed' : 'Failed';
      });
      toast('Averages calculated!', '#2980b9');
      renderStudents();
    }

    function rankStudents() {
      students.sort((a, b) => b.average - a.average);
      students.forEach((s, i) => s.rank = i + 1);
      toast('Students ranked!', '#9b59b6');
      renderStudents();
    }

    function renderStudents(isRegular = false) {
      const container = isRegular ? document.getElementById('students-list-user') : document.getElementById('students-list');
      container.innerHTML = '';
      students.forEach((s, i) => {
        const div = document.createElement('div');
        div.className = 'student-card';
        div.innerHTML = `<h3>${s.name} (${s.class})</h3>
          ${s.subjects.map(sub => `<p>${sub.name}: ${sub.mark}</p>`).join('')}
          <p>Average: ${s.average || 'N/A'} | Status: ${s.status || 'N/A'} | Rank: ${s.rank || 'N/A'}</p>
          <button onclick='generatePdf(${i})'>Generate Report</button>`;
        container.appendChild(div);
      });
    }

    function generatePdf(index) {
      const s = students[index];
      const doc = new jsPDF();

      doc.setFontSize(12);
      doc.text('ABC High School', 10, 10);
      doc.text('Academic Year: 2024/2025', 150, 10, { align: 'right' });

      doc.setFontSize(16);
      doc.text('Student Report Card', 105, 20, { align: 'center' });

      doc.setFontSize(12);
      doc.text(`Name: ${s.name}`, 10, 30);
      doc.text(`Class: ${s.class}`, 10, 40);
      doc.text(`Average: ${s.average || 'N/A'}`, 10, 50);
      doc.text(`Status: ${s.status || 'N/A'}`, 10, 60);
      doc.text(`Rank: ${s.rank || 'N/A'}`, 10, 70);

      doc.autoTable({ startY: 80, head: [['Subject', 'Mark']], body: s.subjects.map(sub => [sub.name, sub.mark]) });

      const pageHeight = doc.internal.pageSize.height;
      doc.setFontSize(10);
      doc.text('Powered by Student Report System', 105, pageHeight - 10, { align: 'center' });

      doc.save(`${s.name}_Report.pdf`);
    }

    function generateAllPDF() {
      students.forEach((_, i) => generatePdf(i));
    }
  </script>
</body>
</html>
