<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Existing meta tags and styles remain the same -->
  <style>
    /* Add new styles for logs section */
    .log-entry {
      padding: 8px;
      margin: 5px 0;
      background-color: #f8f9fa;
      border-radius: 4px;
      font-family: monospace;
    }
    #role {
      width: 100%;
      padding: 10px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>Student Report Card System</h1>

  <div class="auth-panel" id="auth-section">
    <h2>User Authentication</h2>
    <div class="auth-form">
      <input type="text" id="username" placeholder="Username">
      <input type="password" id="password" placeholder="Password">
      <select id="role">
        <option value="user">Regular User</option>
        <option value="admin">Admin/Teacher</option>
      </select>
      <div style="margin-top: 10px">
        <button onclick="signIn()">Sign In</button>
        <button class="btn-success" onclick="signUp()">Sign Up</button>
      </div>
    </div>
  </div>

  <!-- Add logs panel -->
  <div class="panel" id="logs-section" style="display:none">
    <h2>Activity Logs</h2>
    <div id="logs-list"></div>
  </div>

  <!-- Existing panels remain the same -->

  <script>
    // Initialize crypto object
    const crypto = window.crypto || window.msCrypto;

    // Password hashing function
    async function hashPassword(password) {
      const encoder = new TextEncoder();
      const data = encoder.encode(password);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // Activity logging function
    function logAction(action, details = null) {
      const logs = JSON.parse(localStorage.getItem('logs')) || [];
      logs.push({
        timestamp: new Date().toISOString(),
        user: currentUser,
        action,
        details
      });
      localStorage.setItem('logs', JSON.stringify(logs));
      if (users[currentUser]?.role === 'admin') renderLogs();
    }

    // Render logs function
    function renderLogs() {
      const logs = JSON.parse(localStorage.getItem('logs')) || [];
      const container = document.getElementById('logs-list');
      container.innerHTML = '';
      logs.forEach(log => {
        const div = document.createElement('div');
        div.className = 'log-entry';
        div.textContent = `${new Date(log.timestamp).toLocaleString()} [${log.user}] ${log.action}`;
        container.appendChild(div);
      });
    }

    // Modified signIn function
    async function signIn() {
      try {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const hashedPassword = await hashPassword(password);

        if (users[username] && users[username].password === hashedPassword) {
          currentUser = username;
          students = users[currentUser].students || [];
          document.getElementById('auth-section').style.display = 'none';
          document.getElementById('main-section').style.display = 'block';
          document.getElementById('controls-section').style.display = 'flex';

          if (users[username].role === 'admin') {
            document.getElementById('logs-section').style.display = 'block';
            renderLogs();
          }

          logAction('login');
          toast('Signed in successfully!', '#2ecc71');
          renderStudents();
        } else {
          toast('Invalid credentials', '#e74c3c');
        }
      } catch (error) {
        toast('Login failed', '#e74c3c');
      }
    }

    // Modified signUp function
    async function signUp() {
      try {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const role = document.getElementById('role').value;

        if (users[username]) {
          toast('Username already exists', '#e74c3c');
          return;
        }

        const hashedPassword = await hashPassword(password);
        users[username] = {
          password: hashedPassword,
          role: role,
          students: []
        };

        localStorage.setItem('users', JSON.stringify(users));
        logAction('signup', { role });
        toast('Account created! Please sign in.', '#2ecc71');
      } catch (error) {
        toast('Signup failed', '#e74c3c');
      }
    }

    // Modified saveStudent function with logging
    function saveStudent() {
      // Existing student saving logic
      logAction('student_added', { name, className });
    }

    // Modified calculation functions with logging
    function calculateAll() {
      // Existing calculation logic
      logAction('calculate_averages');
    }

    function rankStudents() {
      // Existing ranking logic
      logAction('rank_students');
    }

    // Modified PDF generation with logging
    function generatePdf(index) {
      // Existing PDF generation logic
      logAction('generate_report', { student: students[index].name });
    }

    // Rest of the existing code remains the same
  </script>
</body>
</html>
