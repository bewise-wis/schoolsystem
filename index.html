<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Keep existing head content -->
    <style>
        /* Add these styles to existing CSS */
        .dashboard {
            display: none;
            opacity: 0;
            animation: fadeIn 0.5s 0.2s forwards;
        }

        .student-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        .student-card:hover {
            transform: translateY(-2px);
        }

        .subject-row {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }

        .stats-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .system-controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .badge-primary {
            background: #3498db20;
            color: #3498db;
        }

        .badge-success {
            background: #27ae6020;
            color: #27ae60;
        }

        .badge-danger {
            background: #e74c3c20;
            color: #e74c3c;
        }
    </style>
</head>
<body>
    <!-- Keep auth section -->

    <div class="dashboard" id="dashboard">
        <div class="system-controls">
            <button class="btn btn-primary" onclick="showStudentForm()">Add New Student</button>
            <button class="btn btn-success" onclick="calculateAll()">Calculate Averages</button>
            <button class="btn btn-secondary" onclick="rankStudents()">Rank Students</button>
            <button class="btn btn-danger" onclick="generateAllPDF()">Export All Reports</button>
            <button class="btn" onclick="signOut()" style="margin-left: auto;">Sign Out</button>
        </div>

        <div class="stats-card">
            <h3>Class Statistics</h3>
            <div class="grid-container">
                <div>
                    <p>Total Students: <span id="totalStudents">0</span></p>
                    <p>Class Average: <span id="classAverage">0.00</span></p>
                </div>
                <div>
                    <p>Top Student: <span id="topStudent">-</span></p>
                    <p>Pass Rate: <span id="passRate">0%</span></p>
                </div>
            </div>
        </div>

        <div id="studentForm" class="hidden">
            <div class="stats-card">
                <h3>Add New Student</h3>
                <div class="form-group">
                    <input type="text" id="studentName" class="form-input" placeholder="Student Full Name">
                </div>
                <div class="form-group">
                    <select id="studentClass" class="form-input">
                        <option value="Grade 9">Grade 9</option>
                        <option value="Grade 10">Grade 10</option>
                        <option value="Grade 11">Grade 11</option>
                        <option value="Grade 12">Grade 12</option>
                    </select>
                </div>
                <div class="form-group">
                    <h4>Subjects</h4>
                    <div id="subjectsContainer"></div>
                    <button class="btn btn-secondary" onclick="addSubject()">Add Subject</button>
                </div>
                <div class="system-controls">
                    <button class="btn btn-success" onclick="saveStudent()">Save Student</button>
                    <button class="btn btn-danger" onclick="hideStudentForm()">Cancel</button>
                </div>
            </div>
        </div>

        <div id="studentsList" class="grid-container"></div>
    </div>

    <script>
        // Add these functions to existing JavaScript
        let currentUser = null;
        let students = [];

        function showDashboard() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('dashboard').style.display = 'block';
            loadUserData();
        }

        function loadUserData() {
            students = users[currentUser].students || [];
            updateStatistics();
            renderStudents();
        }

        function showStudentForm() {
            document.getElementById('studentForm').classList.remove('hidden');
            document.getElementById('studentsList').classList.add('hidden');
        }

        function hideStudentForm() {
            document.getElementById('studentForm').classList.add('hidden');
            document.getElementById('studentsList').classList.remove('hidden');
        }

        function addSubject() {
            const container = document.getElementById('subjectsContainer');
            const div = document.createElement('div');
            div.className = 'subject-row';
            div.innerHTML = `
                <input type="text" class="form-input" placeholder="Subject Name" style="flex:2">
                <input type="number" class="form-input" placeholder="Mark" min="0" max="100" step="0.1" style="flex:1">
                <button class="btn btn-danger" onclick="this.parentElement.remove()">Ã—</button>
            `;
            container.appendChild(div);
        }

        function saveStudent() {
            const student = {
                name: document.getElementById('studentName').value.trim(),
                className: document.getElementById('studentClass').value,
                subjects: [],
                id: Date.now().toString()
            };

            document.querySelectorAll('#subjectsContainer .subject-row').forEach(row => {
                const subject = row.querySelector('input[type="text"]').value.trim();
                const mark = parseFloat(row.querySelector('input[type="number"]').value);
                if (subject && !isNaN(mark)) student.subjects.push({ subject, mark });
            });

            if (!student.name || student.subjects.length === 0) {
                showError('Please fill all required fields');
                return;
            }

            students.push(student);
            users[currentUser].students = students;
            localStorage.setItem('users', JSON.stringify(users));
            
            hideStudentForm();
            updateStatistics();
            renderStudents();
            showSuccess('Student record saved!');
        }

        function renderStudents() {
            const container = document.getElementById('studentsList');
            container.innerHTML = '';
            
            students.forEach((student, index) => {
                const card = document.createElement('div');
                card.className = 'student-card';
                card.innerHTML = `
                    <h3>${student.name} <span class="badge badge-primary">${student.className}</span></h3>
                    ${student.subjects.map(sub => `
                        <p>${sub.subject}: <strong>${sub.mark}</strong></p>
                    `).join('')}
                    ${student.average ? `
                        <p>Average: <strong>${student.average}</strong></p>
                        <p>Status: <span class="badge ${student.average >= 60 ? 'badge-success' : 'badge-danger'}">
                            ${student.status}
                        </span></p>
                    ` : ''}
                    <div class="system-controls" style="margin-top:15px">
                        <button class="btn btn-secondary" onclick="generatePdf(${index})">PDF Report</button>
                        <button class="btn btn-danger" onclick="deleteStudent(${index})">Delete</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function calculateAll() {
            students.forEach(student => {
                const total = student.subjects.reduce((sum, sub) => sum + sub.mark, 0);
                student.average = (total / student.subjects.length).toFixed(2);
                student.status = student.average >= 60 ? 'Pass' : 'Fail';
            });
            updateStatistics();
            renderStudents();
            showSuccess('Averages calculated!');
        }

        function rankStudents() {
            students.sort((a, b) => b.average - a.average);
            students.forEach((student, index) => student.rank = index + 1);
            renderStudents();
            showSuccess('Ranking updated!');
        }

        function updateStatistics() {
            document.getElementById('totalStudents').textContent = students.length;
            
            const averages = students.map(s => parseFloat(s.average)).filter(a => !isNaN(a));
            const classAverage = averages.length ? 
                (averages.reduce((a, b) => a + b, 0) / averages.length).toFixed(2) : 0;
            document.getElementById('classAverage').textContent = classAverage;

            const passed = students.filter(s => s.status === 'Pass').length;
            const passRate = students.length ? ((passed / students.length) * 100).toFixed(1) : 0;
            document.getElementById('passRate').textContent = `${passRate}%`;

            const topStudent = students.sort((a, b) => b.average - a.average)[0];
            document.getElementById('topStudent').textContent = topStudent?.name || '-';
        }

        function deleteStudent(index) {
            if (confirm('Delete this student record?')) {
                students.splice(index, 1);
                users[currentUser].students = students;
                localStorage.setItem('users', JSON.stringify(users));
                renderStudents();
                updateStatistics();
                showSuccess('Student record deleted');
            }
        }

        function signOut() {
            currentUser = null;
            students = [];
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('authSection').classList.remove('hidden');
            clearForm();
        }

        // Modify existing signIn function
        async function handleSignIn(username, password) {
            const user = users[username];
            if (!user) {
                showError('User not found');
                return;
            }

            const validPassword = await verifyPassword(password, user.password);
            if (!validPassword) {
                showError('Invalid password');
                return;
            }

            currentUser = username;
            showDashboard();
            showSuccess(`Welcome ${user.role === 'admin' ? 'Admin' : 'Teacher'} ${username}!`);
        }

        // Keep PDF generation functions from previous implementation
    </script>
</body>
</html>
